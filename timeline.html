<html lang="en">
  <head>
    <meta charset="utf-8">
    <title> 上海奉贤 11-01 地块变迁 </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <div id="page-content"></div>
    <script type="text/javascript" src="https://www.altizure.cn/sdk"></script>
    <script>

      function setDefaultValue(vari, defaultValue) {
        if (!vari) {
          return defaultValue
        }
        const defautlProps = Object.getOwnPropertyNames(defaultValue)
        for (let prop in defautlProps) {
          if (!vari.hasOwnProperty(prop)) {
            vari[prop] = defaultValue[prop]
          }
        }
        return vari
      }

      function timelineGrid(sandbox, projects, cameraPos, projOffset, labelOffset) {
        if (!sandbox) {
          console.log('No sandbox to render the grid timeline')
          return
        }
        if (!projects || projects.length == 0) {
          console.log('empty project')
          return
        }

        cameraPos = setDefaultValue(cameraPos, {
          lng: 113.94255600866971,
          lat: 22.538388886344876,
          alt: 1020,
          north:-27.271585092584015,
          tilt:74.7023627906978
        })

        console.log(cameraPos)

        projOffset = setDefaultValue(projOffset, {
          lng: 0.009,
          lat: 0.006
        })

        console.log(projOffset)

        labelOffset = setDefaultValue(labelOffset, {
          lng: -0.004,
          lat: 0
        })

        console.log(labelOffset)

        const centerLat = cameraPos.lat
        const centerLng = cameraPos.lng
        const cameraAlt = cameraPos.lat
        const projLatOffset = projOffset.lat // in y dir
        const projLngOffset = projOffset.lng // in x dir
        const labelLatOffset = labelOffset.lat
        const labelLngOffset = labelOffset.lng

        sandbox.camera.flyTo(cameraPos)

        const projCount = projects.length
        const projCol = Math.ceil(Math.sqrt(projCount))
        const projRow = projCol

        console.log(projCount, projCol, projRow)

        const projLatOrigin = centerLat - projRow * 0.5 * projLatOffset
        const projLngOrigin = centerLng - projCol * 0.5 * projLngOffset
        let labels = []

        for (let i = 0; i < projRow; ++i) {
          for (let j = 0; j < projCol; ++j) {
            let idx = i*projCol + j

            if (idx >= projCount) {
              continue
            }

            const projLat = projLatOrigin + i * projLatOffset
            const projLng = projLngOrigin + j * projLngOffset

            const labelLat = projLat + labelLatOffset
            const labelLng = projLng + labelLngOffset

            const proj = projects[idx]
            sandbox.add('AltizureProjectMarker', {
              pid: proj.pid,
              pose: {
                position: {lng: projLng, lat: projLat, alt: 0}
              }
            }).then((m) => {
              console.log(m)
            })

            // console.log(projMarker)

            let label = new altizure.TextTagMarker({
              // text string
              text: proj.text,
              // text style
              textStyle: {
                fillStyle: 'rgb(255, 255, 255)',
                font: 'normal 500 24px Arial',
                outlineWidth: 2,
                outlineStyle: 'rgb(0, 0, 0)'
              },

              // icon position
              position: {
                "lng": labelLng,
                "lat": labelLat,
                "alt": 0
              },
              // scene
              sandbox: sandbox,
              scale: 6 // icon size
            })
            labels.push(label)
          }
        }

        let titleLabel = new altizure.TextTagMarker({
          // text string
          text: '奉贤 11-01 地块变迁图 ©伊比路',
          // text style
          textStyle: {
            fillStyle: 'rgb(255, 255, 255)',
            font: 'normal 500 24px Arial',
            outlineWidth: 2,
            outlineStyle: 'rgb(0, 0, 0)'
          },

          // icon position
          position: {
            "lng": centerLng + labelLngOffset,
            "lat": projLatOrigin + labelLngOffset, // offset in lat direction
            "alt": 0
          },
          // scene
          sandbox: sandbox,
          scale: 10 // icon size
        })
      }

      let projects = [
        // {pid: '589db9acb504a864ad62f538', text: '拆迁 2017-02-10'},
        {pid: '589a79f0b76d7a3780a5619f', text: '2017-02-08'},
        {pid: '58b9825d03f7216ab68c8f40', text: '2017-03-03'},
        {pid: '58d38790f387231e6c934618', text: '2017-03-23'},
        {pid: '58f0acf13353456af3bc07f9', text: '2017-04-14'}, // 4
        {pid: '5907f9725a6dbd3af41a13bb', text: '2017-05-02'}, // 6
        {pid: '59226d12b8cfc91d91c6e3c4', text: '2017-05-22'},
        {pid: '593161a1772c3e6384a21e0a', text: '2017-06-02'},
        {pid: '5940eccdc2d9527ab86db784', text: '2017-06-14'},
        {pid: '5950d6b941b158666ac8ef0d', text: '2017-06-26'},
        {pid: '595dd8f80c2e073b37a3e901', text: '2017-07-06'},
        {pid: '59b72e6ad5e441395a688086', text: '2017-07-12'}, // 12
        {pid: '5971b024f444896164baa5a1', text: '2017-07-21'}, // 13
        {pid: '597abc586c6ad2616b38c79e', text: '2017-07-28'},
        {pid: '598d4bb72d6ac94215a0d653', text: '2017-08-11'},
        {pid: '59b5fd94d5e441395a608959', text: '2017-08-22'},
        {pid: '59b64aa3d5e441395a6350ff', text: '2017-08-30'},
        {pid: '59b5e063d5e441395a5f932b', text: '2017-09-08'},
        {pid: '59c49a8bf2348f2d1cf72823', text: '2017-09-22'},
        {pid: '59ccb9675fba3242652c908b', text: '2017-09-28'}, // 20
        {pid: '59e9ee079e3fa71ac066e530', text: '2017-10-20'}, // 22
        {pid: '5a0014dc1ef61f5d21d6b940', text: '2017-11-06'} // 24
      ]

      let centerLat = 22.538388886344876
      let centerLng = 113.94255600866971
      let cameraAlt = 1020
      let projLatOffset = 0.006 // in y dir
      let projLngOffset = 0.009 // in x dir
      let labelLatOffset = 0
      let labelLngOffset = -0.004

      let options = {
        altizureApi:{
          key: '7MkQf8UggsPaadvrlKALspJWZejZAJOLHn3cnIy'
        },
        camera: {
          poseTo: { alt:1200,
            lat:centerLat,
            lng:centerLng },
          flyTo: { alt:cameraAlt,
            lat:centerLat,
            lng:centerLng,
            north:-27.271585092584015,
            tilt:74.7023627906978 }
        },
        renderItems: {
          earth: false,
          earthUseTexture: false,
          featureInView: false,
          orbitRing: false
        }
      }

      let sandbox = new altizure.Sandbox('page-content', options)

      timelineGrid(sandbox, projects, {
        lng: 113.94255600866971,
        lat: 22.538388886344876,
        alt: 1020
      }, {
        lng: 0.009,
        lat: 0.006
      }, {
        lng: -0.004,
        lat: 0
      })
    </script>
  </body>
</html>
