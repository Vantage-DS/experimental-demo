<html lang="en">
  <head>
    <meta charset="utf-8">
    <title> GPS Tracker </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="./css/style.css">
    <script type="text/javascript" src="https://www.altizure.cn/sdk"></script>
    <script type="text/javascript" src="./js/timeline.js"></script>
  </head>
  <body>
    <div id="root">
      <div class="hud">
        <div class="component">
          <div class="componentLabel">Camera</div>
          <button class="button button1" id="orbitbutton">Orbit</button>
        </div>
        <div class="component">
          <div class="componentLabel">Tracker</div>
          <button class="button button1" id="startTrack">Start</button>
          <div class="componentLabel">Waypoint #: </div>
          <div class="componentText" id="waypointTrack"> N/A </div>
          <button class="button button1" id="clearTrack">Clear</button>
        </div>
        <div class="component">
          <div class="componentLabel">Last waypoint</div>
          <div class="componentText" id="lastWaypoint"> N/A; N/A; N/A </div>
        </div>
        <!-- <div id="pickpoint" class="component" style="visibility: hidden">
          <div class="componentLabel">Pick</div>
          <label class="switch">
            <input type="checkbox" id="pickSwitch">
            <span class="switchSlider"></span>
          </label>
          <div id="pickpointText" class="componentText"> N/A </div>
        </div> -->
      </div>
      <div id="page-content"></div>
    </div>

    <script>
      // check whether the geo location is enabled
      function checkGeoLocation () {
        navigator.geolocation.getCurrentPosition(onPageLoaded,
          (error) => {
            alert('You must enable geolocation to run this demo')
            alert(error)
            console.log(error)
          }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        })
      }

      function onPageLoaded () {
        let projects = [
          {pid: '59aedc49b891807f43aac819', text: 'Outdoor Stadium Â©INDrone'}
        ]

        const center = {
          lat:22.538388886344876,
          lng:113.94255600866971,
          alt:1020
        }

        let options = {
          altizureApi:{
            key: '7MkQf8UggsPaadvrlKALspJWZejZAJOLHn3cnIy'
          },
          camera: {
            poseTo: { alt:1200,
              lat:22.538388886344876,
              lng:113.94255600866971 },
            flyTo: { alt: center.alt,
              lat: center.lat,
              lng: center.lng,
              north:-27.271585092584015,
              tilt:74.7023627906978 }
          },
          renderItems: {
            earth: true,
            earthUseTexture: false,
            featureInView: false,
            orbitRing: false
          }
        }

        let sandbox = new altizure.Sandbox('page-content', options)
        let pagecontent = document.getElementById("page-content")

        // camera orbit animation
        let orbitButton = document.getElementById("orbitbutton")
        let orbitAnimation = null
        orbitButton.innerHTML = 'Orbit'
        orbitButton.addEventListener("click", () => {
          if (orbitButton.innerHTML === 'Orbit') {
            if (orbitAnimation) {
              clearInterval(orbitAnimation)
            }
            orbitAnimation = setInterval(function() {
              let currentPos = sandbox.camera.pose
              currentPos.north += 10
              sandbox.camera.pose = currentPos
            }, 500)
            orbitButton.innerHTML = 'Stop'
          } else {
            if (orbitAnimation) {
              clearInterval(orbitAnimation)
            }
            orbitButton.innerHTML = 'Orbit'
          }
        })

        timelineLayout(sandbox, projects, {
          cameraPos: center,
          projOffset: {
            lng: 0,
            lat: 0
          },
          labelOffset: {
            lng: 0,
            lat: -0.002
          },
          defaultVisible: true,
          title: ''
        }).then((entities) => {
          // add polyline marker
          let trackMarker = null
          //
          // After the scene is loaded, start to initialize all other event handlers
          //
          let trackedWayPoints = []
          const geoOptions = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }

          const altOffset = 10

          // insert a user tag
          let userTag = new altizure.TagMarker({
            imgUrl: './images/altizure-logo.png',
            // icon position
            position: {
              lat: center.lat,
              lng: center.lng,
              alt: altOffset
            },
            // scene
            sandbox: sandbox,
            visible: true,
            scale: 1 // icon size
          })

          // set start record mode
          let startTrackButton = document.getElementById("startTrack")
          let trackText = document.getElementById("waypointTrack")
          let lastWaypointText = document.getElementById("lastWaypoint")
          if (startTrackButton){
            let trackTimer = null
            startTrackButton.addEventListener('click', (e) => {
              if (startTrackButton.innerHTML === 'Start') {
                startTrackButton.innerHTML = 'Stop'
                if (!trackTimer) {
                  // clearInterval(trackTimer)
                  navigator.geolocation.clearWatch(trackTimer)
                }
                trackTimer = navigator.geolocation.watchPosition((pos) => {
                    console.log(pos)
                    // insert the waypoints
                    if (trackedWayPoints.length === 0) {
                      // initialize the list of waypoints
                      trackedWayPoints.push({
                        position: {
                          lat: pos.coords.latitude,
                          lng: pos.coords.longitude,
                          alt: pos.coords.altitude
                        },
                        orientation: {
                          northing: 0
                        },
                        timeStamp: pos.timestamp
                      })
                    } else {
                      const distance = greatCircleDistance(trackedWayPoints[trackedWayPoints.length-1].position.lat,
                        trackedWayPoints[trackedWayPoints.length-1].position.lng,
                        pos.coords.latitude,
                        pos.coords.longitude
                      )
                      if (distance > 4) {
                        // insert new way point, if the user moves more than 4 meters
                        trackedWayPoints.push({
                          position: {
                            lat: pos.coords.latitude,
                            lng: pos.coords.longitude,
                            alt: pos.coords.altitude
                          },
                          orientation: {
                            northing: 0
                          },
                          timeStamp: pos.timestamp
                        })
                        if (trackMarker) {
                          const pt = trackedWayPoints[trackedWayPoints.length - 1]
                          trackMarker.addPointMarker(new altizure.LngLatAlt(
                            center.lng + pt.position.lng -  trackedWayPoints[0].position.lng,
                            center.lat + pt.position.lat - trackedWayPoints[0].position.lat,
                            altOffset
                          ))
                        }
                      }
                    }

                    if (trackedWayPoints.length >= 2 && !trackMarker) {
                      let points = trackedWayPoints.map((pt) => {
                        return new altizure.LngLatAlt(
                          center.lng + pt.position.lng -  trackedWayPoints[0].position.lng,
                          center.lat + pt.position.lat - trackedWayPoints[0].position.lat,
                          altOffset)
                      })
                      // create the track marker if the waypoints is >= 2
                      trackMarker = new altizure.PolyLineMarker({
                        name: 'tracks',
                        sandbox: sandbox,
                        points: points,
                        color: 0xb73026, // line color
                        fenceHeight: 5 // line height (for visualization)
                      })
                    }

                    // update userTag position, userTag and text are updated everytime pos is updated
                    userTag.setPose({
                        lat: center.lat + pos.coords.latitude - trackedWayPoints[0].position.lat,
                        lng: center.lng + pos.coords.longitude -  trackedWayPoints[0].position.lng,
                        alt: altOffset
                      },
                      undefined,
                      undefined
                    )

                    // update text
                    lastWaypointText.innerHTML = '' + (center.lat + pos.coords.latitude - trackedWayPoints[0].position.lat).toPrecision(9) + '; ' + (center.lng + pos.coords.longitude -  trackedWayPoints[0].position.lng).toPrecision(9) + '; ' + altOffset
                    trackText.innerHTML = '' + trackedWayPoints.length
                  }, (error) => {
                    console.log(error)
                    alert(error)
                    lastWaypointText.innerHTML = 'Error in location change'
                  },
                  geoOptions
                )
              } else {
                startTrackButton.innerHTML = 'Start'
                if (!trackTimer) {
                  // clearInterval(trackTimer)
                  navigator.geolocation.clearWatch(trackTimer)
                  lastWaypointText.innerHTML = 'N/A; N/A; N/A'
                  trackText.innerHTML = '' + trackedWayPoints.length
                }
              }
            })
          }

          let clearTrackButton = document.getElementById('clearTrack')
          if (clearTrackButton) {
            clearTrackButton.addEventListener('click', (e) => {
              trackedWayPoints = []
            })
          }
        })
      }
      document.addEventListener("DOMContentLoaded", checkGeoLocation)
    </script>
  </body>
</html>
